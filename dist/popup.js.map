{
  "version": 3,
  "sources": ["../src/api.js", "../src/firefox_popup.js"],
  "sourcesContent": ["// import log from './log' // eslint-disable-line\n\nconst requestProps = (reviewToken = false, extraProps = {}) => {\n  const headers = { 'Content-Type': 'application/json' }\n  if (reviewToken) {\n    headers.Authorization = `Bearer ${reviewToken}`\n  }\n\n  const defaultProps = {\n    method: 'POST', // because default to some method\n    async: true,\n    headers: headers,\n    contentType: 'json'\n  }\n  return { ...defaultProps, ...extraProps }\n}\n\n// Returns true/false\nconst isReviewTokenValid = (authUrl, reviewToken) => new Promise((resolve, reject) => {\n  const authStatusUrl = `${authUrl}/status`\n\n  return fetch(authStatusUrl, requestProps(reviewToken, { method: 'GET' }))\n    .then(response => response.json()\n      .then((json) => {\n        resolve(json.message !== 'missing user' && response.status === 200)\n      })\n    ).catch((e) => {\n      reject(e)\n    })\n})\n\nconst getReviewToken = (authUrl, loginFormData) => new Promise((resolve, reject) => {\n  const rProps = {\n    method: 'POST',\n    async: true,\n    headers: { 'Content-Type': 'application/json' },\n    contentType: 'json',\n    body: loginFormData\n  }\n  return fetch(authUrl, rProps)\n    .then(response => response.json()\n      .then((json) => {\n        let result = {}\n        if (response.status !== 200 || typeof (json.review_token) === 'undefined' || json.review_token === null) {\n          result.messages = [['error', json.message]]\n        } else {\n          result = { reviewToken: json.review_token, messages: [['success', 'authenticated']] }\n        }\n        resolve(result)\n      })\n    ).catch((e) => {\n      reject(e)\n    })\n})\n\nconst submitReview = (reviewUrl, reviewToken, reviewFormData) => new Promise((resolve, reject) => {\n  const rProps = requestProps(reviewToken, { body: reviewFormData })\n\n  // log.debug(rProps)\n  return fetch(reviewUrl, rProps)\n    .then(response => response.json()\n      .then((json) => {\n        if (response.status === 200) {\n          resolve({ success: true, messages: [['success', json.message]] })\n        } else {\n          resolve({ success: false, messages: [['error', json.message]] })\n        }\n      })\n    ).catch((e) => {\n      reject(e)\n    })\n})\n\nexport default {\n  getReviewToken,\n  isReviewTokenValid,\n  requestProps,\n  submitReview\n}\n", "// import log from './log' // eslint-disable-line\nimport api from './api' // eslint-disable-line\n\nbrowser.storage.local.get('reviewToken')\n  .then(data => data.reviewToken)\n  .then(reviewToken => {\n    if (typeof (reviewToken) === 'undefined' || reviewToken === null) {\n      loginTime()\n    } else {\n      window.reviewToken = reviewToken\n      reviewTime() // I'm worried that this will interfere with\n      checkReviewToken(reviewToken)\n    }\n  })\n\nbrowser.tabs.query({ active: true, currentWindow: true }, function (tabs) {\n  // since only one tab should be active and in the current window at once\n  // the return variable should only have one entry\n  const activeTab = tabs[0]\n  // window.storedTabUrl = activeTab.url // this is available in updateReviewFields\n  // log.debug(tabs[0])\n  updateReviewFields(activeTab.url, activeTab.title)\n})\n\nconst checkReviewToken = async function (token) {\n  const authUrl = formAuthUrl()\n  // pause and rerun if DOM hasn't loaded\n  if (typeof (authUrl) === 'undefined' || authUrl === null) {\n    // log.debug(`authUrl not present in DOM, trying later (${token})`)\n    return setTimeout(checkReviewToken, 50, token)\n  }\n  // log.debug('checking review token:', token)\n  const result = await api.isReviewTokenValid(authUrl, token)\n  if (result) { return }\n  // Remove the existing data that is incorrect - maybe actually do in form submit?\n  browser.storage.local.remove('reviewToken')\n  window.reviewToken = undefined\n  loginTime()\n}\n\nconst updateReviewFields = (tabUrl, title) => {\n  // pause and rerun if DOM hasn't loaded\n  const reviewUrlField = document.getElementById('submitted_url')\n  if (typeof (reviewUrlField) === 'undefined' || reviewUrlField === null) {\n    // log.debug('reviewUrlField not present in DOM, trying later')\n    return setTimeout(updateReviewFields, 50, tabUrl, title)\n  }\n  reviewUrlField.value = tabUrl\n  document.getElementById('citation_title').value = title\n}\n\nconst formAuthUrl = () => document.getElementById('new_user')?.getAttribute('action')\nconst formNewReviewUrl = () => document.getElementById('new_review')?.getAttribute('action')\n\nconst loginTime = () => {\n  // log.debug(\"it's login time\")\n  // pause and rerun if DOM hasn't loaded\n  const loginForm = document.getElementById('new_user')\n  if (typeof (loginForm) === 'undefined' || loginForm === null) {\n    // log.debug('login form not present in DOM, trying later')\n    return setTimeout(loginTime, 50)\n  }\n  loginForm.classList.remove('hidden')\n  document.getElementById('new_review')?.classList?.add('hidden')\n  loginForm.addEventListener('submit', handleLoginSubmit)\n}\n\nconst reviewTime = () => {\n  // pause and rerun if DOM hasn't loaded\n  const reviewForm = document.getElementById('new_review')\n  if (typeof (reviewForm) === 'undefined' || reviewForm === null) {\n    // log.debug('review form not present in DOM, trying later')\n    return setTimeout(reviewTime, 50)\n  }\n  // I think it's a good thing to attach the event listener to the review form\n  reviewForm.addEventListener('submit', handleReviewSubmit)\n  // ... but only show or hide the form if reviewToken is set, in case of weird callback stuff\n  if (window.reviewToken) {\n    document.getElementById('new_user').classList.add('hidden')\n    reviewForm.classList.remove('hidden')\n  }\n}\n\nconst handleLoginSubmit = async function (e) {\n  e.preventDefault()\n  const formData = new FormData(document.getElementById('new_user'))\n  const jsonFormData = JSON.stringify(Object.fromEntries(formData))\n\n  const result = await api.getReviewToken(formAuthUrl(), jsonFormData)\n  // log.debug(result)\n\n  if (typeof (result.reviewToken) === 'undefined' || result.reviewToken === null) {\n    renderAlerts(result.messages)\n  } else {\n    browser.storage.local.set(result)\n    window.reviewToken = result.reviewToken\n    hideAlerts()\n    reviewTime()\n  }\n\n  return false // fallback prevent submit\n}\n\nconst handleReviewSubmit = async function (e) {\n  e.preventDefault()\n  const formData = new FormData(document.getElementById('new_review'))\n  const jsonFormData = JSON.stringify(Object.fromEntries(formData))\n  const result = await api.submitReview(formNewReviewUrl(), window.reviewToken, jsonFormData)\n  // log.debug(result)\n\n  renderAlerts(result.messages)\n  if (result.success) {\n    document.getElementById('new_review').classList.add('hidden')\n    // Close the popup after pause\n    return setTimeout(window.close, 3000)\n  }\n\n  return false // fallback prevent submit\n}\n\nconst hideAlerts = () => {\n  const visibleAlerts = document.querySelectorAll('.alert')\n  visibleAlerts.forEach(el => el.classList.add('hidden'))\n}\n\nconst renderAlerts = (messages) => {\n  hideAlerts()\n  // messages are arrays of: [kind, text]\n  messages.forEach(arr => {\n    const body = document.getElementById('body-popup')\n    const alert = document.createElement('div')\n    alert.textContent = arr[1]\n    alert.classList.add(`alert-${arr[0]}`, 'alert', 'my-4')\n    body.prepend(alert)\n  })\n}\n\n// browser.storage.local.remove(\"reviewToken\")\n"],
  "mappings": "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",
  "names": []
}
